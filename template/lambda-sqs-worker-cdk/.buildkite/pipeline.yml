agents:
  queue: <%- prodBuildkiteQueueName %>

steps:
  - label: üß™ Test, Lint & Build
    artifact_paths: lib/**/*
    commands:
      - echo '+++ yarn test:ci'
      - yarn test
      - echo '--- yarn lint'
      - yarn lint
      - echo '--- yarn build'
      - yarn build
    env:
      GET_GITHUB_TOKEN: please
    plugins:
      - &aws-sm
        seek-oss/aws-sm#v2.3.1:
          env:
            NPM_READ_TOKEN: arn:aws:secretsmanager:ap-southeast-2:987872074697:secret:npm/npm-read-token
      - &docker-ecr-cache
        seek-oss/docker-ecr-cache#v1.11.0:
          cache-on:
            - package.json
            - yarn.lock
          secrets: id=npm,src=.npmrc
      - &private-npm
        seek-oss/private-npm#v1.2.0:
          env: NPM_READ_TOKEN
      - docker-compose#v3.9.0:
          run: app

  - agents:
      queue: <%- devBuildkiteQueueName %>
    branches: '!renovate/*'
    label: üßñ‚Äç‚ôÄÔ∏è Warm Dev
    command: ':'
    plugins:
      - *aws-sm
      - *private-npm
      - *docker-ecr-cache

  - wait
  - block: üôãüèª‚Äç‚ôÄÔ∏è Deploy Dev
    branches: '!${BUILDKITE_PIPELINE_DEFAULT_BRANCH}'

  - commands:
      - echo '+++ yarn deploy'
      - yarn deploy
    concurrency: 1
    concurrency_group: <%- repoName %>/deploy/{{matrix.environment}}
    env:
      ENVIRONMENT: '{{matrix.environment}}'
    label: '{{matrix.label}}'
    matrix:
      adjustments:
        - with:
            environment: dev
            label: ü§û Deploy Dev
          agents:
            queue: <%- devBuildkiteQueueName %>
          env:
            ENVIRONMENT: dev
          key: deploy-dev
        - with:
            environment: prod
            label: üöÄ Deploy Prod
          branches: ${BUILDKITE_PIPELINE_DEFAULT_BRANCH}
          depends_on: deploy-dev
      setup: {}
    plugins:
      - artifacts#v1.5.0:
          build: ${BUILDKITE_BUILD_ID}
          download: lib/*
      - *aws-sm
      - *private-npm
      - *docker-ecr-cache
      - docker-compose#v3.9.0:
          dependencies: false
          run: app
    retry:
      manual:
        # Only use this if you need to roll back a deployment ASAP.
        # Always follow up with a proper revert or fix in Git history.
        permit_on_passed: true
